<!-- Copyright (c) 2008-2009  Philippe Bourgau -->

<!-- This program is free software: you can redistribute it and/or modify -->
<!-- it under the terms of the GNU Affero General Public License as
 published by the Free Software Foundation, either version 3 of the
 License, or (at your option) any later version. -->

<!-- This program is distributed in the hope that it will be useful, but -->
<!-- WITHOUT ANY WARRANTY; without even the implied warranty of -->
<!-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the -->
<!-- GNU Affero General Public License for more details. -->

<!-- You should have received a copy of the GNU Affero General Public License -->
<!-- program.  If not, see <http://www.gnu.org/licenses/> -->


<% # ========================================================================
   # FilooFiloo.PlayerController Unit Test
   # ========================================================================
%>
<% content_for('final') do %>

<script>

Test.context("FilooFiloo.VersusController",{

  setup: function()  {
    this.versusController = FilooFiloo.createVersusController();

    that = this;

    this.player = null;
    this.versusController.Player = {
      newRecord: function(values, datasource) {
        that.player = FilooFiloo.Player.newRecord(values, datasource);
	that.player.commitCalled = NO;
        that.player.commit = function() {
          that.player.commitCalled = YES;
        };
	that.player.refreshCalled = NO;
        that.player.refresh = function() {
          that.player.refreshCalled = YES;
        };
        return that.player;
      }
    };

    this.timer = null;
    this.versusController.Timer = {
      schedule: function(params) {
        that.timer = {
          parameters: params,
	  invalidateCalled: NO,
          invalidate: function() {
	     this.invalidateCalled = YES;
	  }
        }
	return that.timer;
      }
    };
  },

  "forceLoginAndDo should set up the login panel": function() {
    var closeLoginPaneCalled = NO;
    this.versusController.forceLoginAndDo('Test login', 'login, tester:', function() { closeLoginPaneCalled = YES; });

    'Test login'.shouldEqual(this.versusController.get('loginTitle'));
    'login, tester:'.shouldEqual(this.versusController.get('loginCaption'));
    YES.shouldEqual(this.versusController.get('loginTextRequired'));
    YES.shouldEqual(this.versusController.get('loginPaneVisible'));
    NO.shouldEqual(closeLoginPaneCalled);

    this.versusController.set('name', 'johnny be good');
    this.versusController.closeLoginPane();
    NO.shouldEqual(this.versusController.get('loginPaneVisible'));
    YES.shouldEqual(closeLoginPaneCalled);
  },

  "The login pane should not be closed if no name was entered": function() {
    var closeLoginPaneCalled = NO;
    this.versusController.forceLoginAndDo('Test login', 'login, tester:', function() { closeLoginPaneCalled = YES; });
    this.versusController.closeLoginPane();
    YES.shouldEqual(this.versusController.get('loginPaneVisible'));
    NO.shouldEqual(closeLoginPaneCalled);
  },

  "If already entered, the login pane should not ask for a name": function() {
    this.versusController.set('name', 'already');
    this.versusController.forceLoginAndDo('Test login', 'login, tester:', function() {});

    NO.shouldEqual(this.versusController.get('loginTextRequired'));
    YES.shouldEqual(this.versusController.get('loginPaneVisible'));
  },

  "Entering versus mode should force a login and start waiting for an opponent": function() {

    this.versusController.set('currentMode', 'versus')
    YES.shouldEqual(this.versusController.get('loginPaneVisible'));

    this.versusController.set('name', 'zinzin');
    this.versusController.closeLoginPane();

    'Waiting for an opponent ...'.shouldEqual(this.versusController.get('whatIsPlayerDoing'));
    assertNotNull(this.player);

    YES.shouldEqual(this.player.commitCalled);

    assertNotNull(this.timer);
    assertNotNull(this.timer.parameters);
    assertNotNull(this.timer.parameters.target);
    assertNotNull(this.timer.parameters.action);
    YES.shouldEqual(this.timer.parameters.repeats);

    NO.shouldEqual(this.player.refreshCalled);
    this.timer.parameters.target[this.timer.parameters.action]();
    YES.shouldEqual(this.player.refreshCalled);

    this.player.set('opponentName', 'gyzmo');
    this.timer.parameters.target[this.timer.parameters.action]();
    'Playing against gyzmo'.shouldEqual(this.versusController.get('whatIsPlayerDoing'));
    YES.shouldEqual(this.versusController.get('board').get('playing'));
  },

  "No login dialog should be shown when entering versus mode with a name": function() {
    this.versusController.set('name', 'zinzin');
    this.versusController.set('currentMode', 'versus')
    NO.shouldEqual(this.versusController.get('loginPaneVisible'));
  },
  "We should start waiting for an opponent even if a name was already set": function() {
    this.versusController.set('name', 'zinzin');
    this.versusController.set('currentMode', 'versus')
    'Waiting for an opponent ...'.shouldEqual(this.versusController.get('whatIsPlayerDoing'));
  },
  "We should only start waiting for an opponent in versus mode": function() {
    this.versusController.set('currentMode', 'high_scores')
    NO.shouldEqual(this.versusController.get('loginPaneVisible'));
    assertNotIdentical('Waiting for an opponent ...', this.versusController.get('whatIsPlayerDoing'));
  }

}) ;

// Cancel main() so app does not start
if (window.main && (appMain = main)) main = null ;

</script>

<% end %>
